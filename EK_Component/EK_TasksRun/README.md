# EK_TasksRun - è‡ªåŠ¨ä»»åŠ¡æ³¨å†Œä¸æ‰§è¡Œæ¨¡å—æ–‡æ¡£

## ğŸ“– æ–‡æ¡£è¯´æ˜

æ¬¢è¿ä½¿ç”¨ `EK_TasksRun` æ¨¡å—ï¼æœ¬æ–‡æ¡£æ—¨åœ¨å¸®åŠ©æ‚¨ç†è§£å…¶æ ¸å¿ƒè®¾è®¡æ€æƒ³ï¼Œå¹¶æŒ‡å¯¼æ‚¨å¦‚ä½•å°†å…¶æ— ç¼é›†æˆåˆ°æ‚¨çš„åµŒå…¥å¼é¡¹ç›®ä¸­ï¼Œä»¥å®ç°é«˜æ•ˆã€è§£è€¦çš„æ¨¡å—åŒ–å¼€å‘ã€‚

* ### âœ¨ æ ¸å¿ƒä¼˜åŠ¿ï¼šä¼ ç»Ÿæ–¹å¼ vs EK_TasksRun

  `EK_TasksRun` çš„æ ¸å¿ƒä»·å€¼åœ¨äº**è‡ªåŠ¨åŒ–**å’Œ**è§£è€¦**ã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸ªå…·ä½“çš„åç¨‹ä»»åŠ¡åˆ›å»ºåœºæ™¯ï¼Œæ¥ç›´è§‚å±•ç¤ºå…¶ä¼˜åŠ¿ã€‚

  ### ä¼ ç»Ÿå¼€å‘æ¨¡å¼ (é«˜è€¦åˆ)

  åœ¨ä¼ ç»Ÿæ¨¡å¼ä¸‹ï¼Œ`main` å‡½æ•°éœ€è¦äº†è§£æ‰€æœ‰éœ€è¦åˆ›å»ºçš„åç¨‹ä»»åŠ¡ï¼Œå¹¶æ‰‹åŠ¨è°ƒç”¨å®ƒä»¬çš„åˆ›å»ºå‡½æ•° `EK_pCoroCreate`ã€‚

  ```c
  // main.c
  #include "sys.h"
  #include "Kernel.h"
  #include "EK_CoroTask.h"
  
  // ä»»åŠ¡1 å’Œ ä»»åŠ¡2 çš„å…·ä½“å®ç°...
  void Task1(void* arg){/*...*/}
  void Task2(void* arg){/*...*/}
  
  int main(void)
  {
  	// åˆå§‹åŒ–
  	DebugInit();
  	EK_vKernelInit();
  
  	// æ‰‹åŠ¨åˆ›å»ºæ¯ä¸€ä¸ªä»»åŠ¡
  	// mainå‡½æ•°å¿…é¡»çŸ¥é“Task1å’ŒTask2çš„å­˜åœ¨
  	EK_pCoroCreate(Task1, NULL, 0, 1024);
  	EK_pCoroCreate(Task2, NULL, 1, 1024);
  
  	// å¯åŠ¨è°ƒåº¦å™¨
  	EK_vKernelStart();
  
  	while (1) {}
  }
  ```

  - **ç¼ºç‚¹**ï¼š`main` å‡½æ•°ä¸ `Task1`ã€`Task2` ç­‰å…·ä½“ä»»åŠ¡ç´§å¯†è€¦åˆã€‚å¦‚æœæƒ³æ–°å¢ä¸€ä¸ª `Task3` æˆ–è€…ç¦ç”¨ `Task2`ï¼Œéƒ½å¿…é¡»ç›´æ¥ä¿®æ”¹ `main.c` æ–‡ä»¶ï¼Œè¿™åœ¨ä¸­å¤§å‹é¡¹ç›®ä¸­ä¼šå˜å¾—éš¾ä»¥ç»´æŠ¤ã€‚

  ### EK_TasksRun æ¨¡å¼ (ä½è€¦åˆ)

  `EK_TasksRun` å…è®¸å°†ä»»åŠ¡çš„åˆ›å»ºé€»è¾‘å°è£…åœ¨å„è‡ªçš„æ¨¡å—ä¸­ï¼Œ`main` å‡½æ•°åªè´Ÿè´£è§¦å‘æ‰§è¡Œï¼Œæ— éœ€å…³å¿ƒä»»ä½•å…·ä½“ä»»åŠ¡çš„å®ç°ã€‚

  **æ¨¡å—å†…éƒ¨ (`Task_Example.c`)**

  ```c
  // Task_Example.c
  #include "Kernel.h"
  #include "EK_CoroTask.h"
  #include "EK_TasksRun.h"
  
  // ä»»åŠ¡1 å’Œ ä»»åŠ¡2 çš„å…·ä½“å®ç°...
  void Task1(void* arg){/*...*/}
  void Task2(void* arg){/*...*/}
  
  // å®šä¹‰ä¸€ä¸ªä¸“é—¨ç”¨äºåˆ›å»ºè¯¥æ¨¡å—ä»»åŠ¡çš„å…¥å£å‡½æ•°
  void Task_Entry(void)
  {
      EK_CoroHandler_t handler = NULL;
      handler = EK_pCoroCreate(Task1, NULL, 1, 256);
      if (handler == NULL) {
          printf("[Task1] Create Task1 failed!!!\r\n");
      }
  	// å°†handlerä¼ é€’ç»™Task2
      handler = EK_pCoroCreate(Task2, (void*)handler, 2, 256);
      if (handler == NULL) {
          printf("[Task2] Create Task2 failed!!!\r\n");
      }
  }
  
  // æ¨¡å—è‡ªæˆ‘æ³¨å†Œä»»åŠ¡åˆ›å»ºå…¥å£ï¼Œmainå‡½æ•°å¯¹æ­¤å®Œå…¨æ— æ„ŸçŸ¥
  EK_vTaskRegister(Task_Entry);
  ```

  **ä¸»å‡½æ•° (`main.c`)**

  C

  ```c
  // main.c
  #include "sys.h"
  #include "Kernel.h"
  #include "EK_CoroTask.h"
  #include "EK_TasksRun.h"
  
  int main(void)
  {
  	// åˆå§‹åŒ–
  	DebugInit();
  	EK_vKernelInit();
  
  	// ä¸€é”®æ‰§è¡Œæ‰€æœ‰æ¨¡å—å·²æ³¨å†Œçš„ä»»åŠ¡åˆ›å»ºå…¥å£
  	EK_vTasksRun();
  
  	// å¯åŠ¨è°ƒåº¦å™¨
  	EK_vKernelStart();
  
  	while (1) {}
  }
  ```

  - **ä¼˜ç‚¹**ï¼šä»»åŠ¡æ¨¡å—ï¼ˆå¦‚ `Task_Example.c`ï¼‰å¯ä»¥ä½œä¸ºç‹¬ç«‹çš„å•å…ƒè¢«æ·»åŠ åˆ°é¡¹ç›®ä¸­æˆ–ä»é¡¹ç›®ä¸­ç§»é™¤ã€‚`main` å‡½æ•°å§‹ç»ˆä¿æŒå¹²å‡€ã€ç¨³å®šï¼Œæ— éœ€ä»»ä½•æ”¹åŠ¨ï¼ŒçœŸæ­£å®ç°äº†æ¨¡å—çš„â€œå³æ’å³ç”¨â€ï¼Œæå¤§æå‡äº†é¡¹ç›®çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚

---

## ğŸ› ï¸ ç§»æ¤ä¸é…ç½®æŒ‡å—

`EK_TasksRun` çš„å®ç°ä¾èµ–äº **é“¾æ¥å™¨è„šæœ¬** ã€‚æ‚¨å¿…é¡»æ­£ç¡®é…ç½®å®ƒï¼Œå¦åˆ™æ¨¡å—å°†æ— æ³•å·¥ä½œã€‚

### ç³»ç»Ÿæ¶æ„

æœ¬æ¨¡å—é€šè¿‡ `__attribute__((section(".EK_TaskEntry")))` å°†æ‰€æœ‰ä»»åŠ¡å‡½æ•°çš„æŒ‡é’ˆæ”¶é›†åˆ°åŒä¸€ä¸ªæ•°æ®æ®µã€‚é“¾æ¥å™¨è´Ÿè´£å°†è¿™äº›åˆ†æ•£çš„æŒ‡é’ˆèšåˆæˆä¸€ä¸ªè¿ç»­çš„æ•°ç»„ã€‚`EK_vTasksRun` å‡½æ•°åˆ™é€šè¿‡é“¾æ¥å™¨ç”Ÿæˆçš„è¾¹ç•Œç¬¦å·ï¼ˆå¦‚ `Image$$...$$Base/Limit`ï¼‰æ¥éå†è¿™ä¸ªæ•°ç»„ã€‚

### å…³é”®é…ç½® (ARM Compiler 6)

åœ¨æ‚¨çš„ `.sct` åˆ†æ•£åŠ è½½æ–‡ä»¶ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªç”¨äºå­˜æ”¾ä»»åŠ¡æŒ‡é’ˆçš„æ‰§è¡ŒåŸŸï¼š

**ä»£ç æ®µ**

```plaintext
LR_IROM1 0x08000000 0x00010000 {
	ER_IROM1 0x08000000 0x00010000 {
		*.o (RESET, +First) 
		*(InRoot$$Sections) 
		.ANY (+RO) 
		.ANY (+XO) 
	}

	; ====> å°†æ‰€æœ‰ .EK_TaskEntry æ®µèšåˆåˆ°è¿™é‡Œ <====
    EK_TASK_ENTRIES +0
    {
        *(.EK_TaskEntry)
    }
    ; ===========================================

	RW_IRAM1 0x20000000 0x00005000 {
		.ANY (+RW +ZI) 
	}
}
```

### å…¼å®¹æ€§ä¸æœªæ¥è§„åˆ’

* **å½“å‰å·²éªŒè¯å¹³å°** :
* **å·¥å…·é“¾** : ARM Compiler 6 (AC6)
* **ç¡¬ä»¶** : STM32F1 ç³»åˆ—
* **æœªæ¥é€‚é…è®¡åˆ’** :
* **ARM Compiler 5 (AC5)** : éªŒè¯ `.sct` æ–‡ä»¶å…¼å®¹æ€§ã€‚
* **GCC for ARM** : ç¼–å†™ `.ld` é“¾æ¥è„šæœ¬ï¼Œå¹¶ä¿®æ”¹Cä»£ç ä»¥é€‚é… GCC ã€‚

---

## ğŸ“– API å‚è€ƒæ‰‹å†Œ

### æ•°æ®ç±»å‹

#### `EK_TaskEntry_t`

```c
typedef void (*EK_TaskEntry_t)(void);
```

**æè¿°** : å®šä¹‰äº†ä»»åŠ¡å…¥å£å‡½æ•°çš„æ ‡å‡†åŸå‹ã€‚æ‰€æœ‰è¢«æ³¨å†Œçš„ä»»åŠ¡å…¥å£éƒ½å¿…é¡»æ˜¯æ— å‚æ•°ã€æ— è¿”å›å€¼çš„å‡½æ•°ã€‚

### å®å®šä¹‰

#### `EK_vTaskRegister(func)`

```c
#define EK_vTaskRegister(func) EK_TASK_ADD(func)
```

* **æè¿°** : æ³¨å†Œä¸€ä¸ªä»»åŠ¡å…¥å£å‡½æ•°ï¼Œä½¿å…¶å¯ä»¥è¢« `EK_vTasksRun` æ‰§è¡Œã€‚è¿™æ˜¯æ¨¡å—æœ€æ ¸å¿ƒçš„ APIã€‚
* **å‚æ•°** :
  * `func`: `[in]` è¦æ³¨å†Œçš„å…¥å£å‡½æ•°åï¼Œå…¶ç±»å‹å¿…é¡»ç¬¦åˆ `EK_TaskEntry_t`ã€‚

* **ä½¿ç”¨ç¤ºä¾‹** :

```c
  void Task_Entry(void) { /* ... */ }
  EK_vTaskRegister(Task_Entry);
```

### å‡½æ•°

#### `EK_vTasksRun(void)`

```c
void EK_vTasksRun(void);
```

* **æè¿°** : æ‰§è¡Œæ‰€æœ‰å·²é€šè¿‡ `EK_vTaskRegister` æ³¨å†Œçš„ä»»åŠ¡å…¥å£ã€‚è¯¥å‡½æ•°é€šå¸¸åœ¨ç³»ç»Ÿæ—¶é’Ÿç­‰åŸºç¡€é…ç½®å®Œæˆåï¼Œä¸»å¾ªç¯å¼€å§‹å‰è°ƒç”¨ã€‚
* **è¿”å›å€¼** : æ— ã€‚
* **æ³¨æ„** : è°ƒç”¨æ­¤å‡½æ•°å‰ï¼Œå¿…é¡»ç¡®ä¿é“¾æ¥å™¨è„šæœ¬å·²æ­£ç¡®é…ç½®ã€‚

---

## ğŸ› å¸¸è§é—®é¢˜è§£ç­”

**æš‚æ— **

---

## ğŸ”„ ç‰ˆæœ¬ä¿¡æ¯

* **å½“å‰ç‰ˆæœ¬** : v1.0
* **æ›´æ–°æ—¥æœŸ** : 2025-10-22
* **ç¼–è¯‘å™¨æ”¯æŒ** : AC6
* **ç›®æ ‡æ¶æ„** : ARM Cortex-M

---

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸš€
