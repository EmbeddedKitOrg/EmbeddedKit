name: éƒ¨ç½²æ–‡æ¡£åˆ°GitHub Pages

on:
  push:
    branches:
      - master
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®GITHUB_TOKENæƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªéƒ¨ç½²åœ¨è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  collect-docs:
    name: æ”¶é›†å’Œå¤„ç†æ–‡æ¡£
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºè·å–æœ€åä¿®æ”¹æ—¶é—´
        
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '.github/scripts/package.json'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        cd .github/scripts
        npm install --only=production
        
    - name: æ”¶é›†READMEæ–‡ä»¶
      run: |
        echo "å¼€å§‹æ”¶é›†é¡¹ç›®ä¸­çš„READMEæ–‡ä»¶..."
        node .github/scripts/collect-readme.js
        
    - name: ç”Ÿæˆæ–‡æ¡£ç´¢å¼•
      run: |
        echo "ç”Ÿæˆdocsifyç›®å½•ç´¢å¼•..."
        node .github/scripts/generate-sidebar.js
        
    - name: éªŒè¯æ–‡æ¡£ç»“æ„
      run: |
        echo "éªŒè¯ç”Ÿæˆçš„æ–‡æ¡£ç»“æ„..."
        ls -la docs/
        echo "--- _sidebar.md å†…å®¹ ---"
        cat docs/_sidebar.md
        
    - name: è®¾ç½®Pages
      uses: actions/configure-pages@v4
      
    - name: æ„å»ºæ–‡æ¡£ç«™ç‚¹
      run: |
        # å¤åˆ¶docsifyé…ç½®åˆ°docsç›®å½•
        cp .docsify/index.html docs/
        
        # åˆ›å»º.nojekyllæ–‡ä»¶ï¼Œé˜²æ­¢GitHub Pageså¤„ç†ä¸‹åˆ’çº¿æ–‡ä»¶
        touch docs/.nojekyll
        
        # åˆ›å»ºCNAMEæ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦è‡ªå®šä¹‰åŸŸåï¼‰
        # echo "your-domain.com" > docs/CNAME
        
        echo "æ–‡æ¡£ç«™ç‚¹æ„å»ºå®Œæˆ"
        
    - name: ä¸Šä¼ Pagesåˆ¶å“
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/

  deploy:
    name: éƒ¨ç½²åˆ°GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: collect-docs
    
    steps:
    - name: éƒ¨ç½²åˆ°GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        echo "âœ… æ–‡æ¡£å·²æˆåŠŸéƒ¨ç½²åˆ°GitHub Pages"
        echo "ğŸ“– è®¿é—®åœ°å€: ${{ steps.deployment.outputs.page_url }}"