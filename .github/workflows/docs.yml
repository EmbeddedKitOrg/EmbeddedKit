name: Deploy Documentation

on:
  push:
    branches: [ master, main ]
    paths:
      - 'docs/**'
      - 'src/**/*.c'
      - 'src/**/*.h'
      - 'include/**/*.h'
      - '.github/workflows/docs.yml'
      - 'scripts/generate-sidebar.js'
      - 'scripts/update-docs-index.py'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'docs/**'
  workflow_dispatch:
  schedule:
    # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ›´æ–°æ–‡æ¡£
    - cron: '0 2 * * 0'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          ~/.cache/pip
        key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json', '**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-deps-
    
    - name: Install dependencies
      run: |
        # å®‰è£…Node.jsä¾èµ–
        npm install -g docsify-cli
        npm install -g glob
        
        # å®‰è£…Pythonä¾èµ–
        pip install -r requirements-docs.txt || true
    
    - name: Collect module READMEs
      run: |
        echo "ğŸ”„ æ”¶é›†æ¨¡å—READMEæ–‡ä»¶..."
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p docs/auto-generated
        
        # æ”¶é›†æ‰€æœ‰æ¨¡å—çš„README
        for dir in src/*; do
          if [ -d "$dir" ]; then
            module_name=$(basename "$dir")
            if [ -f "$dir/README.md" ]; then
              echo "  ğŸ“ æ‰¾åˆ°æ¨¡å—: $module_name"
              cp "$dir/README.md" "docs/auto-generated/${module_name}.md"
            fi
          fi
        done
        
        # ç”Ÿæˆæ¨¡å—ç´¢å¼•
        echo "# è‡ªåŠ¨æ”¶é›†çš„æ¨¡å—æ–‡æ¡£" > docs/auto-generated/index.md
        echo "" >> docs/auto-generated/index.md
        echo "ä»¥ä¸‹æ–‡æ¡£ä»æºä»£ç ç›®å½•è‡ªåŠ¨æ”¶é›†ï¼š" >> docs/auto-generated/index.md
        echo "" >> docs/auto-generated/index.md
        
        for file in docs/auto-generated/*.md; do
          if [ -f "$file" ] && [ "$(basename "$file")" != "index.md" ]; then
            module_name=$(basename "$file" .md)
            echo "- [$module_name](auto-generated/$module_name.md)" >> docs/auto-generated/index.md
          fi
        done
    
    - name: Generate documentation structure
      run: |
        echo "ğŸ“ ç”Ÿæˆæ–‡æ¡£ç»“æ„..."
        
        # è¿è¡Œä¾§è¾¹æ ç”Ÿæˆè„šæœ¬
        if [ -f "scripts/generate-sidebar.js" ]; then
          node scripts/generate-sidebar.js
        fi
        
        # è¿è¡Œæ–‡æ¡£ç´¢å¼•è„šæœ¬
        if [ -f "scripts/update-docs-index.py" ]; then
          python scripts/update-docs-index.py
        fi
        
        # ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        echo '{"version": "'$(git describe --tags --always)'"}' > docs/package.json
    
    - name: Extract API documentation
      run: |
        echo "ğŸ” æå–APIæ–‡æ¡£..."
        
        # ä½¿ç”¨doxygenæˆ–å…¶ä»–å·¥å…·æå–APIæ–‡æ¡£
        if command -v doxygen &> /dev/null; then
          if [ -f "Doxyfile" ]; then
            doxygen Doxyfile
          fi
        fi
        
        # ä»å¤´æ–‡ä»¶ç”ŸæˆAPIæ–‡æ¡£
        python scripts/extract-api-docs.py || true
    
    - name: Build documentation stats
      run: |
        echo "ğŸ“Š ç”Ÿæˆæ–‡æ¡£ç»Ÿè®¡..."
        
        # ç»Ÿè®¡æ–‡æ¡£ä¿¡æ¯
        echo "## æ–‡æ¡£ç»Ÿè®¡" > docs/stats.md
        echo "" >> docs/stats.md
        echo "- æ€»æ–‡æ¡£æ•°: $(find docs -name '*.md' | wc -l)" >> docs/stats.md
        echo "- æ€»ä»£ç è¡Œæ•°: $(find src -name '*.c' -o -name '*.h' | xargs wc -l | tail -1 | awk '{print $1}')" >> docs/stats.md
        echo "- æ¨¡å—æ•°é‡: $(ls -d src/*/ 2>/dev/null | wc -l)" >> docs/stats.md
        echo "- æœ€åæ›´æ–°: $(date '+%Y-%m-%d %H:%M:%S')" >> docs/stats.md
    
    - name: Validate documentation
      run: |
        echo "âœ… éªŒè¯æ–‡æ¡£å®Œæ•´æ€§..."
        
        # æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        required_files=("docs/index.html" "docs/_sidebar.md" "docs/README.md")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ ç¼ºå°‘å¿…è¦æ–‡ä»¶: $file"
            exit 1
          fi
        done
        
        # æ£€æŸ¥æ­»é“¾æ¥
        python scripts/check-links.py || true
    
    - name: Optimize for production
      run: |
        echo "âš¡ ä¼˜åŒ–ç”Ÿäº§ç¯å¢ƒ..."
        
        # å‹ç¼©å›¾ç‰‡
        if command -v optipng &> /dev/null; then
          find docs -name '*.png' -exec optipng -o5 {} \;
        fi
        
        # ç”Ÿæˆæœç´¢ç´¢å¼•
        echo "ç”Ÿæˆæœç´¢ç´¢å¼•..."
        # docsifyä¼šè‡ªåŠ¨ç”Ÿæˆæœç´¢ç´¢å¼•
    
    - name: Setup GitHub Pages
      if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
      uses: actions/configure-pages@v3
    
    - name: Upload artifact
      if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./docs
    
    - name: Deploy to GitHub Pages
      if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
      id: deployment
      uses: actions/deploy-pages@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create deployment summary
      if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
      run: |
        echo "## ğŸ“š æ–‡æ¡£éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ [åœ¨çº¿æ–‡æ¡£](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### éƒ¨ç½²ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“… éƒ¨ç½²æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”– æäº¤: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ‘¤ è§¦å‘è€…: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š æ–‡æ¡£æ•°é‡: $(find docs -name '*.md' | wc -l)" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… æ–‡æ¡£éƒ¨ç½²æˆåŠŸ"
        else
          echo "âŒ æ–‡æ¡£éƒ¨ç½²å¤±è´¥"
        fi