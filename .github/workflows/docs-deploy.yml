name: éƒ¨ç½²æ–‡æ¡£ç³»ç»Ÿ

# è§¦å‘æ¡ä»¶ï¼šmasteråˆ†æ”¯æ¨é€æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ master ]
    paths:
      - 'README.md'
      - 'src/**'
      - 'include/**'
      - 'examples/**'
      - '.github/workflows/docs-deploy.yml'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# æƒé™è®¾ç½®
permissions:
  contents: write
  pages: write
  id-token: write

# ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªéƒ¨ç½²åœ¨è¿è¡Œ
concurrency:
  group: "pages-deployment"
  cancel-in-progress: false

jobs:
  collect-and-deploy:
    name: æ”¶é›†æ–‡æ¡£å¹¶éƒ¨ç½²åˆ°docsifyåˆ†æ”¯
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºmasteråˆ†æ”¯
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: æ”¶é›†é¡¹ç›®æ–‡æ¡£
      id: collect
      run: |
        echo "ğŸ”„ å¼€å§‹æ”¶é›†é¡¹ç›®æ–‡æ¡£..."
        
        # åˆ›å»ºä¸´æ—¶æ–‡æ¡£ç›®å½•
        mkdir -p temp_docs/modules
        mkdir -p temp_docs/api
        mkdir -p temp_docs/examples
        
        # æ”¶é›†ä¸»README
        if [ -f "README.md" ]; then
          echo "ğŸ“„ æ”¶é›†ä¸»README"
          cp README.md temp_docs/
        fi
        
        # æ”¶é›†æ¨¡å—README
        module_count=0
        if [ -d "src" ]; then
          for dir in src/*/; do
            if [ -d "$dir" ]; then
              module_name=$(basename "$dir")
              if [ -f "$dir/README.md" ]; then
                echo "ğŸ“ æ”¶é›†æ¨¡å—æ–‡æ¡£: $module_name"
                cp "$dir/README.md" "temp_docs/modules/${module_name}.md"
                module_count=$((module_count + 1))
              fi
            fi
          done
        fi
        
        # æ”¶é›†ç¤ºä¾‹æ–‡æ¡£
        example_count=0
        if [ -d "examples" ]; then
          for example in examples/*/; do
            if [ -d "$example" ]; then
              example_name=$(basename "$example")
              if [ -f "$example/README.md" ]; then
                echo "ğŸ’¡ æ”¶é›†ç¤ºä¾‹æ–‡æ¡£: $example_name"
                cp "$example/README.md" "temp_docs/examples/${example_name}.md"
                example_count=$((example_count + 1))
              fi
            fi
          done
        fi
        
        # ç”Ÿæˆæ”¶é›†ç»Ÿè®¡
        echo "modules_collected=$module_count" >> $GITHUB_OUTPUT
        echo "examples_collected=$example_count" >> $GITHUB_OUTPUT
        echo "collection_time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        
    - name: æ£€å‡ºdocsifyåˆ†æ”¯
      run: |
        echo "ğŸ“¦ åˆ‡æ¢åˆ°docsifyåˆ†æ”¯..."
        
        # æ£€æŸ¥docsifyåˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if git show-ref --verify --quiet refs/remotes/origin/docsify; then
          echo "docsifyåˆ†æ”¯å·²å­˜åœ¨ï¼Œæ£€å‡º..."
          git checkout docsify
          git pull origin docsify
        else
          echo "docsifyåˆ†æ”¯ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°åˆ†æ”¯..."
          git checkout --orphan docsify
          git rm -rf .
          
          # åˆ›å»ºåŸºç¡€docsifyç»“æ„
          mkdir -p docs/modules docs/api docs/examples
        fi
        
    - name: æ›´æ–°docsifyåˆ†æ”¯æ–‡æ¡£
      run: |
        echo "ğŸ“ æ›´æ–°docsifyåˆ†æ”¯æ–‡æ¡£..."
        
        # ç¡®ä¿docsç›®å½•å­˜åœ¨
        mkdir -p docs/modules docs/api docs/examples
        
        # å¤åˆ¶æ”¶é›†åˆ°çš„æ–‡æ¡£
        if [ -d "temp_docs" ]; then
          cp -r temp_docs/* docs/ 2>/dev/null || true
        fi
        
        # ç”Ÿæˆä¾§è¾¹æ é…ç½®
        cat > docs/_sidebar.md << 'EOF'
* [é¦–é¡µ](/)
* [å¿«é€Ÿå¼€å§‹](README.md)

* **æ ¸å¿ƒæ¨¡å—**
EOF
        
        # æ·»åŠ æ¨¡å—é“¾æ¥
        if [ -d "docs/modules" ]; then
          for module_file in docs/modules/*.md; do
            if [ -f "$module_file" ]; then
              module_name=$(basename "$module_file" .md)
              echo "  * [$module_name](modules/$module_name.md)" >> docs/_sidebar.md
            fi
          done
        fi
        
        # æ·»åŠ ç¤ºä¾‹é“¾æ¥
        echo "" >> docs/_sidebar.md
        echo "* **ç¤ºä¾‹ä»£ç **" >> docs/_sidebar.md
        if [ -d "docs/examples" ]; then
          for example_file in docs/examples/*.md; do
            if [ -f "$example_file" ]; then
              example_name=$(basename "$example_file" .md)
              echo "  * [$example_name](examples/$example_name.md)" >> docs/_sidebar.md
            fi
          done
        fi
        
        # ç”Ÿæˆå¯¼èˆªæ 
        cat > docs/_navbar.md << 'EOF'
* [GitHub](https://github.com/zuoliangyu/EmbedKit)
* [é—®é¢˜åé¦ˆ](https://github.com/zuoliangyu/EmbedKit/issues)
EOF
        
        # ç”Ÿæˆå°é¢é¡µ
        cat > docs/_coverpage.md << 'EOF'
# EmbedKit

> è½»é‡çº§åµŒå…¥å¼å¼€å‘å·¥å…·åŒ…

- æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
- é«˜æ€§èƒ½ï¼Œä½å†…å­˜å ç”¨
- è¯¦ç»†çš„æ–‡æ¡£å’Œç¤ºä¾‹

[å¼€å§‹ä½¿ç”¨](#quick-start)
[æŸ¥çœ‹GitHub](https://github.com/zuoliangyu/EmbedKit)
EOF
        
        # ç”Ÿæˆä¸»é¡µ
        if [ -f "docs/README.md" ]; then
          # å¦‚æœæ”¶é›†åˆ°ä¸»READMEï¼Œä½¿ç”¨å®ƒ
          echo "ä½¿ç”¨æ”¶é›†åˆ°çš„ä¸»README"
        else
          # å¦åˆ™åˆ›å»ºé»˜è®¤ä¸»é¡µ
          cat > docs/README.md << 'EOF'
# EmbedKit

æ¬¢è¿ä½¿ç”¨ EmbedKit - è½»é‡çº§åµŒå…¥å¼å¼€å‘å·¥å…·åŒ…ï¼

## å¿«é€Ÿå¼€å§‹

è¿™é‡Œæ˜¯é¡¹ç›®çš„æ–‡æ¡£ä¸»é¡µã€‚æ–‡æ¡£ä¼šä»masteråˆ†æ”¯è‡ªåŠ¨æ”¶é›†å’Œæ›´æ–°ã€‚

## é¡¹ç›®ç»“æ„

- **æ ¸å¿ƒæ¨¡å—**: æŸ¥çœ‹å·¦ä¾§å¯¼èˆªä¸­çš„æ¨¡å—æ–‡æ¡£
- **ç¤ºä¾‹ä»£ç **: å­¦ä¹ å¦‚ä½•ä½¿ç”¨å„ä¸ªç»„ä»¶
- **APIæ–‡æ¡£**: è¯¦ç»†çš„æ¥å£è¯´æ˜

## æ›´æ–°è¯´æ˜

æœ¬æ–‡æ¡£ç³»ç»Ÿä¼šåœ¨masteråˆ†æ”¯æ›´æ–°æ—¶è‡ªåŠ¨åŒæ­¥ã€‚æœ€åæ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
EOF
        fi
        
        # ç”Ÿæˆdocsifyé…ç½®
        cat > docs/index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>EmbedKit Documentation</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="description" content="EmbedKit - è½»é‡çº§åµŒå…¥å¼å¼€å‘å·¥å…·åŒ…">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
  <link rel="icon" href="_media/favicon.ico">
</head>
<body>
  <div id="app">åŠ è½½ä¸­...</div>
  <script>
    window.$docsify = {
      name: 'EmbedKit',
      repo: 'https://github.com/zuoliangyu/EmbedKit',
      loadSidebar: true,
      loadNavbar: true,
      coverpage: true,
      onlyCover: false,
      maxLevel: 4,
      subMaxLevel: 2,
      auto2top: true,
      homepage: 'README.md',
      search: {
        maxAge: 86400000, // è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ¯«ç§’ï¼Œé»˜è®¤ä¸€å¤©
        paths: 'auto',
        placeholder: 'ğŸ” æœç´¢æ–‡æ¡£',
        noData: 'ğŸ˜ æ²¡æœ‰æ‰¾åˆ°ç»“æœ',
        depth: 6
      },
      copyCode: {
        buttonText: 'ğŸ“‹ å¤åˆ¶',
        errorText: 'âŒ å¤åˆ¶å¤±è´¥',
        successText: 'âœ… å·²å¤åˆ¶'
      },
      pagination: {
        previousText: 'â¬…ï¸ ä¸Šä¸€é¡µ',
        nextText: 'ä¸‹ä¸€é¡µ â¡ï¸',
        crossChapter: true
      }
    }
  </script>
  <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>
  <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/docsify-copy-code@2"></script>
  <script src="//cdn.jsdelivr.net/npm/docsify-pagination@2/dist/docsify-pagination.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/prismjs@1/components/prism-c.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/prismjs@1/components/prism-bash.min.js"></script>
</body>
</html>
EOF
        
        # åˆ›å»º.nojekyllæ–‡ä»¶
        touch docs/.nojekyll
        
    - name: æäº¤æ›´æ–°åˆ°docsifyåˆ†æ”¯
      run: |
        echo "ğŸ’¾ æäº¤æ–‡æ¡£æ›´æ–°..."
        
        # é…ç½®git
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # æ·»åŠ æ‰€æœ‰æ–‡æ¡£æ–‡ä»¶
        git add docs/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ–‡æ¡£æ›´æ–°"
        else
          # æäº¤å˜æ›´
          git commit -m "docs: è‡ªåŠ¨æ›´æ–°æ–‡æ¡£ (æ¥è‡ªmasteråˆ†æ”¯)

          ğŸ“Š æ”¶é›†ç»Ÿè®¡:
          - æ¨¡å—æ–‡æ¡£: ${{ steps.collect.outputs.modules_collected }} ä¸ª
          - ç¤ºä¾‹æ–‡æ¡£: ${{ steps.collect.outputs.examples_collected }} ä¸ª
          - æ›´æ–°æ—¶é—´: ${{ steps.collect.outputs.collection_time }}
          - è§¦å‘æäº¤: ${{ github.sha }}

          ğŸ¤– ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ"
          
          # æ¨é€åˆ°docsifyåˆ†æ”¯
          git push origin docsify
          
          echo "âœ… æ–‡æ¡£å·²æ›´æ–°åˆ°docsifyåˆ†æ”¯"
        fi
        
    - name: è®¾ç½®GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: ä¸Šä¼ Pagesåˆ¶å“
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/
        
    - name: éƒ¨ç½²åˆ°GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        echo "## ğŸ“š æ–‡æ¡£éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š æœ¬æ¬¡æ”¶é›†ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”¢ æ”¶é›†æ¨¡å—: ${{ steps.collect.outputs.modules_collected }} ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ’¡ æ”¶é›†ç¤ºä¾‹: ${{ steps.collect.outputs.examples_collected }} ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- â° æ›´æ–°æ—¶é—´: ${{ steps.collect.outputs.collection_time }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
        echo "- [åœ¨çº¿æ–‡æ¡£](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
        echo "- [docsifyåˆ†æ”¯](https://github.com/${{ github.repository }}/tree/docsify)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### â„¹ï¸ è¯´æ˜" >> $GITHUB_STEP_SUMMARY
        echo "æ–‡æ¡£ä»masteråˆ†æ”¯è‡ªåŠ¨æ”¶é›†ï¼Œä¿å­˜åœ¨docsifyåˆ†æ”¯ï¼Œå¹¶è‡ªåŠ¨éƒ¨ç½²åˆ°GitHub Pagesã€‚" >> $GITHUB_STEP_SUMMARY